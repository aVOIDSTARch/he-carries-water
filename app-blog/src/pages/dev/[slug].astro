---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getCollection } from 'astro:content';
import { marked } from 'marked';

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map(project => ({
    params: { slug: project.data.slug },
    props: { project },
  }));
}

const { project } = Astro.props;
const { data } = project;

// Parse README markdown to HTML
const readmeHtml = await marked.parse(data.readme);
---

<html lang="en">
  <head>
    <BaseHead title={`${data.name} - Dev Projects`} description={data.description} />
  </head>
  <body>
    <Header />
    <main class="w-full max-w-[1100px] mx-auto p-4 min-h-screen">
      <div class="flex flex-col lg:flex-row gap-6">
        <!-- Main Content -->
        <div class="flex-1 min-w-0">
          <!-- Project Header -->
          <div class="border-2 border-black bg-white p-6 mb-6 shadow-custom">
            <div class="flex items-start justify-between gap-4 mb-4">
              <div>
                <h1 class="text-3xl md:text-4xl font-mono uppercase font-bold mb-2">
                  {data.name}
                </h1>
                <p class="font-mono text-gray-dark">
                  {data.description}
                </p>
              </div>
              <a
                href={data.githubUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="flex-shrink-0 px-4 py-2 border-2 border-black bg-black text-white font-mono uppercase font-bold hover:bg-accent transition-all shadow-[2px_2px_0px_0px_black] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-none flex items-center gap-2"
              >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                View on GitHub
              </a>
            </div>

            <!-- Stats Row -->
            <div class="flex flex-wrap gap-4 text-sm font-mono">
              {data.language && (
                <span class="flex items-center gap-1 px-2 py-1 border border-accent bg-accent/10 text-accent-dark font-bold">
                  <span class="w-3 h-3 rounded-full bg-accent"></span>
                  {data.language}
                </span>
              )}
              <span class="flex items-center gap-1 px-2 py-1 border border-black bg-gray-light/20">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z"/>
                </svg>
                {data.stars} stars
              </span>
              <span class="flex items-center gap-1 px-2 py-1 border border-black bg-gray-light/20">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878a2.25 2.25 0 1 1 1.5 0v.878a2.25 2.25 0 0 1-2.25 2.25h-1.5v2.128a2.251 2.251 0 1 1-1.5 0V8.5h-1.5A2.25 2.25 0 0 1 3.5 6.25v-.878a2.25 2.25 0 1 1 1.5 0ZM5 3.25a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Zm6.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm-3 8.75a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Z"/>
                </svg>
                {data.forks} forks
              </span>
              {data.license && (
                <span class="flex items-center gap-1 px-2 py-1 border border-black bg-gray-light/20">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8.75.75V2h.985c.304 0 .603.08.867.231l1.29.736c.038.022.08.033.124.033h2.234a.75.75 0 0 1 0 1.5h-.427l2.111 4.692a.75.75 0 0 1-.154.838l-.53-.53.529.531-.001.002-.002.002-.006.006-.02.019-.06.053a4.38 4.38 0 0 1-.812.51c-.374.19-.821.375-1.238.375a3.167 3.167 0 0 1-1.238-.375 4.38 4.38 0 0 1-.812-.51l-.06-.053-.02-.02-.006-.005-.002-.002L11 9.586a.75.75 0 0 1-.154-.838L12.96 4h-1.11a.75.75 0 0 1-.371-.098L10.19 3.17a.25.25 0 0 0-.124-.033H8.75v11.113a2.001 2.001 0 0 1-1.5 0V3.137h-1.066a.25.25 0 0 0-.124.033L4.87 3.902a.75.75 0 0 1-.371.098H3.04l2.11 4.692a.75.75 0 0 1-.153.838l-.53-.53.529.531-.001.002-.002.002-.006.006-.02.019a2.954 2.954 0 0 1-.06.053 4.38 4.38 0 0 1-.812.51c-.374.19-.821.375-1.238.375a3.167 3.167 0 0 1-1.238-.375 4.38 4.38 0 0 1-.812-.51l-.06-.053-.02-.02-.006-.005-.002-.002L.75 9.586a.75.75 0 0 1-.154-.838L2.71 4H2.25a.75.75 0 0 1 0-1.5h2.234c.044 0 .086-.011.124-.033l1.29-.736A1.75 1.75 0 0 1 6.765 2H7.75V.75a.75.75 0 0 1 1 0Z"/>
                  </svg>
                  {data.license}
                </span>
              )}
            </div>

            <!-- Topics -->
            {data.topics.length > 0 && (
              <div class="flex flex-wrap gap-2 mt-4">
                {data.topics.map(topic => (
                  <span class="text-xs font-mono px-2 py-1 border border-black bg-gray-light/20 text-black">
                    {topic}
                  </span>
                ))}
              </div>
            )}
          </div>

          <!-- README Content -->
          <div class="border-2 border-black bg-white p-6 shadow-custom">
            <div class="flex items-center gap-2 mb-4 pb-4 border-b-2 border-black">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16">
                <path d="M0 1.75A.75.75 0 0 1 .75 1h4.253c1.227 0 2.317.59 3 1.501A3.743 3.743 0 0 1 11.006 1h4.245a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75h-4.507a2.25 2.25 0 0 0-1.591.659l-.622.621a.75.75 0 0 1-1.06 0l-.622-.621A2.25 2.25 0 0 0 5.258 13H.75a.75.75 0 0 1-.75-.75Zm7.251 10.324.004-5.073-.002-2.253A2.25 2.25 0 0 0 5.003 2.5H1.5v9h3.757a3.75 3.75 0 0 1 1.994.574ZM8.755 4.75l-.004 7.322a3.752 3.752 0 0 1 1.992-.572H14.5v-9h-3.495a2.25 2.25 0 0 0-2.25 2.25Z"/>
              </svg>
              <h2 class="text-xl font-mono uppercase font-bold">README</h2>
            </div>
            <article class="prose prose-lg max-w-none" set:html={readmeHtml} />
          </div>
        </div>

        <!-- Sidebar -->
        <aside class="lg:w-80 space-y-6">
          <!-- Project Info -->
          <div class="border-2 border-black bg-white p-4 shadow-custom">
            <h3 class="text-sm font-mono uppercase font-bold mb-4 pb-2 border-b-2 border-black">
              Project Info
            </h3>
            <dl class="space-y-3 text-sm font-mono">
              <div>
                <dt class="text-gray uppercase text-xs">Last Updated</dt>
                <dd class="font-bold">
                  {data.lastPushed.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                </dd>
              </div>
              {data.homepage && (
                <div>
                  <dt class="text-gray uppercase text-xs">Homepage</dt>
                  <dd>
                    <a href={data.homepage} target="_blank" rel="noopener noreferrer" class="text-accent hover:underline break-all">
                      {data.homepage.replace(/^https?:\/\//, '')}
                    </a>
                  </dd>
                </div>
              )}
              <div>
                <dt class="text-gray uppercase text-xs">Last Synced</dt>
                <dd class="text-gray-dark">
                  {data.lastSyncedAt.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                </dd>
              </div>
            </dl>
          </div>

          <!-- Latest Release -->
          {data.latestRelease && (
            <div class="border-2 border-black bg-white p-4 shadow-custom">
              <h3 class="text-sm font-mono uppercase font-bold mb-4 pb-2 border-b-2 border-black">
                Latest Release
              </h3>
              <div class="font-mono">
                <a
                  href={data.latestRelease.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-accent hover:underline font-bold"
                >
                  {data.latestRelease.tag}
                </a>
                <p class="text-sm text-gray-dark mt-1">{data.latestRelease.name}</p>
                <p class="text-xs text-gray mt-2">
                  Released {data.latestRelease.publishedAt.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                </p>
              </div>
            </div>
          )}

          <!-- Contributors -->
          {data.contributors.length > 0 && (
            <div class="border-2 border-black bg-white p-4 shadow-custom">
              <h3 class="text-sm font-mono uppercase font-bold mb-4 pb-2 border-b-2 border-black">
                Contributors
              </h3>
              <div class="space-y-3">
                {data.contributors.slice(0, 5).map(contributor => (
                  <a
                    href={contributor.profileUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="flex items-center gap-3 hover:bg-gray-light/20 p-2 -mx-2 transition-colors"
                  >
                    <img
                      src={contributor.avatarUrl}
                      alt={contributor.login}
                      class="w-8 h-8 border border-black"
                    />
                    <div class="flex-1 min-w-0">
                      <div class="font-mono text-sm font-bold truncate">{contributor.login}</div>
                      <div class="font-mono text-xs text-gray">{contributor.contributions} commits</div>
                    </div>
                  </a>
                ))}
              </div>
            </div>
          )}
        </aside>
      </div>

      <!-- Back Link -->
      <div class="mt-8">
        <a
          href="/dev"
          class="inline-block px-6 py-3 border-2 border-black bg-white font-mono uppercase font-bold hover:bg-accent hover:text-white transition-all shadow-[4px_4px_0px_0px_black] hover:translate-x-[4px] hover:translate-y-[4px] hover:shadow-none"
        >
          ‚Üê All Projects
        </a>
      </div>
    </main>
    <Footer />
  </body>
</html>

<style>
  .shadow-custom {
    box-shadow: 4px 4px 0px 0px var(--color-black);
  }

  /* Prose styling for README */
  .prose {
    color: var(--color-gray-dark);
  }

  .prose h1,
  .prose h2,
  .prose h3,
  .prose h4 {
    font-family: 'Space Mono', monospace;
    font-weight: bold;
    text-transform: uppercase;
    color: var(--color-black);
    margin-top: 1.5em;
    margin-bottom: 0.5em;
  }

  .prose h1 {
    font-size: 1.5rem;
    border-bottom: 2px solid var(--color-black);
    padding-bottom: 0.5rem;
  }

  .prose h2 {
    font-size: 1.25rem;
  }

  .prose h3 {
    font-size: 1.1rem;
  }

  .prose p {
    margin-bottom: 1rem;
    line-height: 1.7;
  }

  .prose a {
    color: var(--color-accent);
    text-decoration: underline;
  }

  .prose a:hover {
    color: var(--color-accent-dark);
  }

  .prose code {
    font-family: 'Space Mono', monospace;
    font-size: 0.875em;
    background: var(--color-gray-light);
    padding: 0.2em 0.4em;
    border: 1px solid var(--color-black);
  }

  .prose pre {
    font-family: 'Space Mono', monospace;
    background: var(--color-black);
    color: #00ff00;
    padding: 1rem;
    overflow-x: auto;
    border: 2px solid var(--color-black);
    margin: 1rem 0;
  }

  .prose pre code {
    background: transparent;
    padding: 0;
    border: none;
    color: inherit;
  }

  .prose ul,
  .prose ol {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }

  .prose li {
    margin-bottom: 0.25rem;
  }

  .prose blockquote {
    border-left: 4px solid var(--color-accent);
    padding-left: 1rem;
    margin: 1rem 0;
    font-style: italic;
    color: var(--color-gray);
  }

  .prose img {
    max-width: 100%;
    height: auto;
    border: 2px solid var(--color-black);
  }

  .prose table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
  }

  .prose th,
  .prose td {
    border: 1px solid var(--color-black);
    padding: 0.5rem;
    text-align: left;
  }

  .prose th {
    background: var(--color-gray-light);
    font-weight: bold;
  }
</style>
