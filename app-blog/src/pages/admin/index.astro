---
import { getSession } from 'auth-astro/server';
import AdminLayout from '../../layouts/AdminLayout.astro';
import { logEvent } from '../../lib/audit-logger';
import { getCollection } from 'astro:content';
import type { SeverityLevel } from '../../lib/audit-logger';

const session = await getSession(Astro.request);

// Redirect to login if not authenticated
if (!session) {
	return Astro.redirect('/admin/login');
}

// Get user info
const user = session.user;

// Fetch all events and get the last 10
let recentEvents: any[] = [];
try {
	const allEvents = await getCollection('events');

	// Flatten all events from all files and sort by timestamp
	const flattenedEvents = allEvents.flatMap(file => {
		// Each file contains an array of events
		const events = file.data as any;
		if (Array.isArray(events)) {
			return events;
		}
		// If it's a single event object, wrap it in an array
		return [events];
	});

	// Sort by timestamp (newest first) and take last 10
	recentEvents = flattenedEvents
		.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime())
		.slice(0, 10);
} catch (error) {
	console.error('Error fetching events:', error);
	recentEvents = [];
}

// Helper function to get severity color
const getSeverityColor = (severity: SeverityLevel = 'info') => {
	switch (severity) {
		case 'critical':
			return 'bg-red-600';
		case 'error':
			return 'bg-orange-500';
		case 'warning':
			return 'bg-yellow-500';
		case 'info':
		default:
			return 'bg-blue-500';
	}
};

// Helper function to format date
const formatDate = (timestamp: string) => {
	const date = new Date(timestamp);
	return date.toLocaleString('en-US', {
		month: 'short',
		day: 'numeric',
		hour: '2-digit',
		minute: '2-digit',
	});
};

// Log admin dashboard access
await logEvent({
	timestamp: new Date().toISOString(),
	eventType: 'other',
	title: `Admin dashboard accessed by ${user?.name || user?.email}`,
	description: 'User accessed the admin dashboard',
	user: {
		id: user?.id as string | undefined,
		name: user?.name ?? undefined,
		email: user?.email ?? undefined,
	},
	metadata: {
		path: '/admin',
		method: 'GET',
	},
	tags: ['admin', 'dashboard', 'access'],
	severity: 'info',
	ipAddress: Astro.request.headers.get('x-forwarded-for') || Astro.request.headers.get('x-real-ip') || undefined,
	userAgent: Astro.request.headers.get('user-agent') || undefined,
});
---

<AdminLayout title="Admin Dashboard">
	<div class="space-y-6">
		<!-- Welcome Header -->
		<div class="border-2 border-black bg-accent/10 p-6 shadow-custom">
			<h1 class="text-3xl font-mono uppercase font-bold mb-2">
				Welcome Back, {user?.name || 'Admin'}!
			</h1>
			<p class="font-mono text-gray-dark">
				Logged in as: <span class="text-accent-dark font-bold">{user?.email || user?.name}</span>
			</p>
		</div>

		<!-- Statistics Cards -->
		<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
			<div class="border-2 border-black bg-white p-6 shadow-custom">
				<div class="text-sm font-mono uppercase text-gray-dark mb-2">Blog Posts</div>
				<div class="text-4xl font-mono font-bold">--</div>
				<a href="/admin/blog" class="text-sm font-mono text-accent hover:underline mt-2 inline-block">
					Manage →
				</a>
			</div>

			<div class="border-2 border-black bg-white p-6 shadow-custom">
				<div class="text-sm font-mono uppercase text-gray-dark mb-2">Mind Ideas</div>
				<div class="text-4xl font-mono font-bold">87</div>
				<a href="/admin/mind" class="text-sm font-mono text-accent hover:underline mt-2 inline-block">
					Manage →
				</a>
			</div>

			<div class="border-2 border-black bg-white p-6 shadow-custom">
				<div class="text-sm font-mono uppercase text-gray-dark mb-2">Media Files</div>
				<div class="text-4xl font-mono font-bold">--</div>
				<a href="/admin/media" class="text-sm font-mono text-accent hover:underline mt-2 inline-block">
					Manage →
				</a>
			</div>
		</div>

		<!-- Quick Actions -->
		<div class="border-2 border-black bg-white p-6 shadow-custom">
			<h2 class="text-xl font-mono uppercase font-bold mb-4 border-b-2 border-black pb-2">
				Quick Actions
			</h2>
			<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
				<a 
					href="/admin/blog/new" 
					class="block px-6 py-4 border-2 border-black bg-accent text-white font-mono uppercase font-bold text-center hover:bg-accent-dark transition-all shadow-[2px_2px_0px_0px_black] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-none"
				>
					+ New Blog Post
				</a>
				<a 
					href="/admin/mind/new" 
					class="block px-6 py-4 border-2 border-black bg-accent text-white font-mono uppercase font-bold text-center hover:bg-accent-dark transition-all shadow-[2px_2px_0px_0px_black] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-none"
				>
					+ New Mind Idea
				</a>
			</div>
		</div>

		<!-- Recent Activity -->
		<div class="border-2 border-black bg-white p-6 shadow-custom">
			<h2 class="text-xl font-mono uppercase font-bold mb-4 border-b-2 border-black pb-2">
				Recent Activity
			</h2>

			{recentEvents.length === 0 ? (
				<p class="font-mono text-gray-dark text-center py-8">
					No recent activity to display
				</p>
			) : (
				<div class="space-y-3">
					{recentEvents.map((event) => (
						<div class="border-2 border-black bg-white shadow-[2px_2px_0px_0px_black] overflow-hidden flex">
							<!-- Severity Color Bar -->
							<div class={`w-2 ${getSeverityColor(event.severity)}`}></div>

							<!-- Event Content -->
							<div class="flex-1 p-4">
								<div class="flex items-start justify-between gap-4">
									<div class="flex-1">
										<h3 class="font-mono font-bold text-sm mb-1">
											{event.title}
										</h3>

										{event.description && (
											<p class="font-mono text-xs text-gray-dark mb-2">
												{event.description}
											</p>
										)}

										<div class="flex flex-wrap gap-2 items-center">
											<!-- Event Type Badge -->
											<span class="inline-block px-2 py-1 bg-gray-100 border border-black text-xs font-mono uppercase">
												{event.eventType.replace(/_/g, ' ')}
											</span>

											<!-- User Info -->
											{event.user?.name && (
												<span class="text-xs font-mono text-gray-dark">
													by <span class="font-bold">{event.user.name}</span>
												</span>
											)}

											<!-- Tags -->
											{event.tags && event.tags.length > 0 && (
												<div class="flex gap-1">
													{event.tags.slice(0, 3).map((tag: string) => (
														<span class="inline-block px-1.5 py-0.5 bg-accent/10 border border-accent text-xs font-mono">
															#{tag}
														</span>
													))}
												</div>
											)}
										</div>
									</div>

									<!-- Timestamp -->
									<div class="text-right">
										<time class="text-xs font-mono text-gray-dark whitespace-nowrap">
											{formatDate(event.timestamp)}
										</time>

										<!-- Severity Badge -->
										<div class="mt-1">
											<span class={`inline-block px-2 py-0.5 text-xs font-mono uppercase font-bold border-2 border-black
												${event.severity === 'critical' ? 'bg-red-600 text-white' : ''}
												${event.severity === 'error' ? 'bg-orange-500 text-white' : ''}
												${event.severity === 'warning' ? 'bg-yellow-500 text-black' : ''}
												${event.severity === 'info' ? 'bg-blue-100 text-blue-900' : ''}
											`}>
												{event.severity || 'info'}
											</span>
										</div>
									</div>
								</div>

								<!-- Related Content Link -->
								{event.relatedContent?.url && (
									<a
										href={event.relatedContent.url}
										class="inline-block mt-2 text-xs font-mono text-accent hover:underline"
									>
										View {event.relatedContent.type} →
									</a>
								)}
							</div>
						</div>
					))}
				</div>
			)}

			<!-- View All Link -->
			{recentEvents.length > 0 && (
				<div class="mt-4 pt-4 border-t-2 border-black">
					<a
						href="/admin/events"
						class="text-sm font-mono text-accent hover:underline font-bold"
					>
						View All Activity →
					</a>
				</div>
			)}
		</div>
	</div>
</AdminLayout>

<style>
	.shadow-custom {
		box-shadow: 4px 4px 0px 0px var(--color-black);
	}
</style>
